<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="Security &amp; Android &amp; Java">
<meta property="og:type" content="website">
<meta property="og:title" content="Fitz.Lee">
<meta property="og:url" content="https://fitzlee.github.io/page/6/index.html">
<meta property="og:site_name" content="Fitz.Lee">
<meta property="og:description" content="Security &amp; Android &amp; Java">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fitz.Lee">
<meta name="twitter:description" content="Security &amp; Android &amp; Java">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fitzlee.github.io/page/6/"/>





  <title>Fitz.Lee</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fitz.Lee</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/resume/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/android_app_plugin_hotfix.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/android_app_plugin_hotfix.html" itemprop="url">Android中间件-插件化和热补丁等</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-10T00:00:00+00:00">
                2017-04-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/10Android-App/" itemprop="url" rel="index">
                    <span itemprop="name">10Android_App</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>应用在Google市场上架之前会经过安全扫描，包含病毒的应用无法上架。目前安卓应用可以通过下载并动态加载dex/jar/elf/的方式，进行升级，以达到以下目的：问题修复，版本升级等。这都是热补丁的正常使用方式。除此之外，个别恶意应用利用热补丁技术，故意使上架检测版本和实际运行版本不一致，恶意绕过上架检测机制。</p>
<p>提供的动态加载接口有Dexclassloader、Desfile.loadDex、System.load、System.loadlibrary，它们底层在虚拟机的实现接口是openDexFileNative和JVM_NativeLoad，分别用于加载dex/jar和so格式的文件，应用通过调用这些接口实现动态加载。</p>
<p>那么热补丁插件的实现方式大概有以下几种：</p>
<p>##Android中间件</p>
<p>###插件化<br><a href="http://weishu.me/2016/01/28/understand-plugin-framework-overview/" target="_blank" rel="noopener">http://weishu.me/2016/01/28/understand-plugin-framework-overview/</a><br><a href="https://github.com/wangwangheng/BestBlogReprinted_AndroidNotes/tree/master/%E6%8F%92%E4%BB%B6%E5%BC%8F%E5%BC%80%E5%8F%91/weishu%E7%B3%BB%E5%88%97" target="_blank" rel="noopener">https://github.com/wangwangheng/BestBlogReprinted_AndroidNotes/tree/master/%E6%8F%92%E4%BB%B6%E5%BC%8F%E5%BC%80%E5%8F%91/weishu%E7%B3%BB%E5%88%97</a><br><a href="http://blog.csdn.net/ganyao939543405/article/details/76146760" target="_blank" rel="noopener">http://blog.csdn.net/ganyao939543405/article/details/76146760</a><br><a href="https://cloud.tencent.com/developer/article/1038868" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1038868</a><br><a href="http://www.10tiao.com/html/227/201703/2650239063/1.html" target="_blank" rel="noopener">http://www.10tiao.com/html/227/201703/2650239063/1.html</a><br><a href="https://github.com/tiann/understand-plugin-framework" target="_blank" rel="noopener">https://github.com/tiann/understand-plugin-framework</a><br><a href="http://www.10tiao.com/html/227/201703/2650239063/1.html" target="_blank" rel="noopener">http://www.10tiao.com/html/227/201703/2650239063/1.html</a><br><a href="https://github.com/prife/VirtualAppDoc" target="_blank" rel="noopener">https://github.com/prife/VirtualAppDoc</a></p>
<p>###热修复<br><a href="http://www.androidchina.net/6213.html" target="_blank" rel="noopener">http://www.androidchina.net/6213.html</a><br><a href="https://github.com/Tencent/tinker/wiki" target="_blank" rel="noopener">https://github.com/Tencent/tinker/wiki</a><br><a href="https://www.cnblogs.com/popfisher/p/8543973.html" target="_blank" rel="noopener">https://www.cnblogs.com/popfisher/p/8543973.html</a><br>深入探索Android热修复技术原理 by 阿里 pdf<br>AndFix原理 <a href="https://blog.csdn.net/jiangwei0910410003/article/details/53099390" target="_blank" rel="noopener">https://blog.csdn.net/jiangwei0910410003/article/details/53099390</a></p>
<p>###Hook框架<br><a href="http://www.snowdream.tech/2016/09/02/android-install-xposed-framework/" target="_blank" rel="noopener">http://www.snowdream.tech/2016/09/02/android-install-xposed-framework/</a><br><a href="https://jaq.alibaba.com/community/art/show?articleid=809" target="_blank" rel="noopener">https://jaq.alibaba.com/community/art/show?articleid=809</a></p>
<p>##VirtualXposed 和epic<br><a href="https://github.com/android-hacker/VirtualXposed" target="_blank" rel="noopener">https://github.com/android-hacker/VirtualXposed</a><br><a href="https://github.com/tiann/epic" target="_blank" rel="noopener">https://github.com/tiann/epic</a><br><a href="http://weishu.me/2017/12/02/non-root-xposed/" target="_blank" rel="noopener">http://weishu.me/2017/12/02/non-root-xposed/</a></p>
<p>classLoader的问题<br><a href="https://blog.csdn.net/xiangzhihong8/article/details/52880327" target="_blank" rel="noopener">https://blog.csdn.net/xiangzhihong8/article/details/52880327</a><br><a href="http://weishu.me/2016/04/05/understand-plugin-framework-classloader/" target="_blank" rel="noopener">http://weishu.me/2016/04/05/understand-plugin-framework-classloader/</a></p>
<p>插件的原理<br><a href="https://github.com/wangwangheng/BestBlogReprinted_AndroidNotes/blob/master/%E6%8F%92%E4%BB%B6%E5%BC%8F%E5%BC%80%E5%8F%91/weishu%E7%B3%BB%E5%88%97/1.Android%E6%8F%92%E4%BB%B6%E5%8C%96%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90%E2%80%94%E2%80%94%E6%A6%82%E8%A6%81.md" target="_blank" rel="noopener">https://github.com/wangwangheng/BestBlogReprinted_AndroidNotes/blob/master/%E6%8F%92%E4%BB%B6%E5%BC%8F%E5%BC%80%E5%8F%91/weishu%E7%B3%BB%E5%88%97/1.Android%E6%8F%92%E4%BB%B6%E5%8C%96%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90%E2%80%94%E2%80%94%E6%A6%82%E8%A6%81.md</a><br>首先要明白静态代理/动态代理/hook原理机制，静态代理在程序运行前，代理类的.class文件就已经存在了。动态代理类：在程序运行时，运用JDK本身反射机制动态创建而成，如果复杂可能要用cglib；创建出来的对象都集成的相同的接口。动态代理主要设计以下几个方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Shopping women = new ShoppingImpl();</span><br><span class="line">// 正常购物</span><br><span class="line">System.out.println(Arrays.toString(women.doShopping(100)));</span><br><span class="line">// 招代理</span><br><span class="line">women = (Shopping) Proxy.newProxyInstance(Shopping.class.getClassLoader(),</span><br><span class="line">                women.getClass().getInterfaces(), new ShoppingHandler(women));</span><br><span class="line">System.out.println(Arrays.toString(women.doShopping(100)));</span><br><span class="line"></span><br><span class="line">public class ShoppingHandler implements InvocationHandler &#123;</span><br><span class="line">    Object base;</span><br><span class="line">    public ShoppingHandler(Object base) &#123;</span><br><span class="line">        this.base = base;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">       if (&quot;doShopping&quot;.equals(method.getName())) &#123;</span><br><span class="line">        System.out.println(String.format(&quot;花了%s块钱&quot;, readCost));</span><br><span class="line">        Object[] things = (Object[]) method.invoke(base, readCost);</span><br><span class="line">       &#125; else if &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是hook相当于直接改变已有类的静态成员或者单例，hook常用发射的方法，来替换成员达到修改相关类的效果。如下方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public static void attachContext() throws Exception&#123;</span><br><span class="line">        // 先获取到当前的ActivityThread对象</span><br><span class="line">        Class&lt;?&gt; activityThreadClass = Class.forName(&quot;android.app.ActivityThread&quot;);</span><br><span class="line">        Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(&quot;currentActivityThread&quot;);</span><br><span class="line">        currentActivityThreadMethod.setAccessible(true);</span><br><span class="line">        //currentActivityThread是一个static函数所以可以直接invoke，不需要带实例参数</span><br><span class="line">        Object currentActivityThread = currentActivityThreadMethod.invoke(null);</span><br><span class="line"></span><br><span class="line">        // 拿到原始的 mInstrumentation字段</span><br><span class="line">        Field mInstrumentationField = activityThreadClass.getDeclaredField(&quot;mInstrumentation&quot;);</span><br><span class="line">        mInstrumentationField.setAccessible(true);</span><br><span class="line">        Instrumentation mInstrumentation = (Instrumentation) mInstrumentationField.get(currentActivityThread);</span><br><span class="line"></span><br><span class="line">        // 创建代理对象</span><br><span class="line">        Instrumentation evilInstrumentation = new EvilInstrumentation(mInstrumentation);</span><br><span class="line"></span><br><span class="line">        // 偷梁换柱</span><br><span class="line">        mInstrumentationField.set(currentActivityThread, evilInstrumentation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>binder的hook，可以通过ServiceManager修改掉相关的其中的sCache这个变量即可，然后填相关service。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">final String CLIPBOARD_SERVICE = &quot;clipboard&quot;;</span><br><span class="line"></span><br><span class="line">// 下面这一段的意思实际就是: ServiceManager.getService(&quot;clipboard&quot;);</span><br><span class="line">// 只不过 ServiceManager这个类是@hide的</span><br><span class="line">Class&lt;?&gt; serviceManager = Class.forName(&quot;android.os.ServiceManager&quot;);</span><br><span class="line">Method getService = serviceManager.getDeclaredMethod(&quot;getService&quot;, String.class);</span><br><span class="line">// ServiceManager里面管理的原始的Clipboard Binder对象</span><br><span class="line">// 一般来说这是一个Binder代理对象</span><br><span class="line">IBinder rawBinder = (IBinder) getService.invoke(null, CLIPBOARD_SERVICE);</span><br><span class="line"></span><br><span class="line">// Hook 掉这个Binder代理对象的 queryLocalInterface 方法</span><br><span class="line">// 然后在 queryLocalInterface 返回一个IInterface对象, hook掉我们感兴趣的方法即可.</span><br><span class="line">IBinder hookedBinder = (IBinder) Proxy.newProxyInstance(serviceManager.getClassLoader(),</span><br><span class="line">        new Class&lt;?&gt;[] &#123; IBinder.class &#125;,</span><br><span class="line">        new BinderProxyHookHandler(rawBinder));</span><br><span class="line"></span><br><span class="line">// 把这个hook过的Binder代理对象放进ServiceManager的cache里面</span><br><span class="line">// 以后查询的时候 会优先查询缓存里面的Binder, 这样就会使用被我们修改过的Binder了</span><br><span class="line">Field cacheField = serviceManager.getDeclaredField(&quot;sCache&quot;);</span><br><span class="line">cacheField.setAccessible(true);</span><br><span class="line">Map&lt;String, IBinder&gt; cache = (Map) cacheField.get(null);</span><br><span class="line">cache.put(CLIPBOARD_SERVICE, hookedBinder);</span><br></pre></td></tr></table></figure></p>
<p>binder的ams hook也是通过类似的方法，替换掉了ActivityManagerNative的gDefault变量来替换。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; activityManagerNativeClass = Class.forName(&quot;android.app.ActivityManagerNative&quot;);</span><br><span class="line"></span><br><span class="line">// 获取 gDefault 这个字段, 想办法替换它</span><br><span class="line">Field gDefaultField = activityManagerNativeClass.getDeclaredField(&quot;gDefault&quot;);</span><br><span class="line">gDefaultField.setAccessible(true);</span><br><span class="line">Object gDefault = gDefaultField.get(null);</span><br><span class="line"></span><br><span class="line">// 4.x以上的gDefault是一个 android.util.Singleton对象; 我们取出这个单例里面的字段</span><br><span class="line">Class&lt;?&gt; singleton = Class.forName(&quot;android.util.Singleton&quot;);</span><br><span class="line">Field mInstanceField = singleton.getDeclaredField(&quot;mInstance&quot;);</span><br><span class="line">mInstanceField.setAccessible(true);</span><br><span class="line"></span><br><span class="line">// ActivityManagerNative 的gDefault对象里面原始的 IActivityManager对象</span><br><span class="line">Object rawIActivityManager = mInstanceField.get(gDefault);</span><br><span class="line"></span><br><span class="line">// 创建一个这个对象的代理对象, 然后替换这个字段, 让我们的代理对象帮忙干活</span><br><span class="line">Class&lt;?&gt; iActivityManagerInterface = Class.forName(&quot;android.app.IActivityManager&quot;);</span><br><span class="line"></span><br><span class="line">Object proxy = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</span><br><span class="line">        new Class&lt;?&gt;[] &#123; iActivityManagerInterface &#125;, </span><br><span class="line">        		new IActivityManagerHandler(rawIActivityManager));</span><br><span class="line">        		</span><br><span class="line">mInstanceField.set(gDefault, proxy);</span><br></pre></td></tr></table></figure></p>
<p>热修复和冷修复的原理<br>动态加载某一个dex或者jar包，替换有问题的类或者方法或者变量，以达到热修复的功能。热修复行不通的情况下，那么就要等待重新启动，冷启动修复对应的dex的方法或类。那么如何替换呢？<br>目前有两种方式，参考sophix，热修复第一种方法是底层替换原理，直接替换调ARTMethod结构体，需要适配每一个版本，比较复杂。另外一种是类加载冷启动的多dex全量替换方式，替换dexElements这个dex文件的list使得虚拟机能优先加载修复过的类，从而达到修复效果。</p>
<p>There are three injection points for a given method: before, after, replace.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Example 1: Attach a piece of code before and after all occurrences of Activity.onCreate(Bundle).</span><br><span class="line"></span><br><span class="line">        // Target class, method with parameter types, followed by the hook callback (XC_MethodHook).</span><br><span class="line">		DexposedBridge.findAndHookMethod(Activity.class, &quot;onCreate&quot;, Bundle.class, new XC_MethodHook() &#123;</span><br><span class="line">        </span><br><span class="line">            // To be invoked before Activity.onCreate().</span><br><span class="line">			@Override protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">				// &quot;thisObject&quot; keeps the reference to the instance of target class.</span><br><span class="line">				Activity instance = (Activity) param.thisObject;</span><br><span class="line">        </span><br><span class="line">				// The array args include all the parameters.</span><br><span class="line">				Bundle bundle = (Bundle) param.args[0];</span><br><span class="line">				Intent intent = new Intent();</span><br><span class="line">				// XposedHelpers provide useful utility methods.</span><br><span class="line">				XposedHelpers.setObjectField(param.thisObject, &quot;mIntent&quot;, intent);</span><br><span class="line">		</span><br><span class="line">				// Calling setResult() will bypass the original method body use the result as method return value directly.</span><br><span class="line">				if (bundle.containsKey(&quot;return&quot;))</span><br><span class="line">					param.setResult(null);</span><br><span class="line">			&#125;</span><br><span class="line">					</span><br><span class="line">			// To be invoked after Activity.onCreate()</span><br><span class="line">			@Override protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">		        XposedHelpers.callMethod(param.thisObject, &quot;sampleMethod&quot;, 2);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">Example 2: Replace the original body of the target method.</span><br><span class="line"></span><br><span class="line">		DexposedBridge.findAndHookMethod(Activity.class, &quot;onCreate&quot;, Bundle.class, new XC_MethodReplacement() &#123;</span><br><span class="line">		</span><br><span class="line">			@Override protected Object replaceHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">				// Re-writing the method logic outside the original method context is a bit tricky but still viable.</span><br><span class="line">				...</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/android_security_pkcs_standard.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/android_security_pkcs_standard.html" itemprop="url">PKCS标准解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-10T00:00:00+00:00">
                2017-04-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/11Android-Security/" itemprop="url" rel="index">
                    <span itemprop="name">11Android_Security</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="PKCS标准-Public-Key-Cryptography-Standards"><a href="#PKCS标准-Public-Key-Cryptography-Standards" class="headerlink" title="PKCS标准  Public-Key Cryptography Standards"></a>PKCS标准  Public-Key Cryptography Standards</h2><p>RSA主导标准，RSA信息安全公司旗下的RSA实验室为了发扬公开密钥技术的使用，1990年开始便发展了一系列的公开密钥密码编译标准。只不过，虽然该标准具有相当大的象征性，也被信息界的产业所认同；但是，若RSA公司认为有必要，这些标准的内容仍然可能会更动。所幸，这些变动并不大；此外，这几年RSA公司也与其他组织（比较知名的有IETF、PKIX）将标准的制定通过standards track程序来达成。</p>
<p>1)    PKCS#1：RSA加密标准。PKCS#1定义了RSA公钥函数的基本格式标准，特别是数字签名。它定义了数字签名如何计算，包括待签名数据和签名本身的格式；它也定义了PSA公/私钥的语法<br>2)    PKCS#2：涉及了RSA的消息摘要加密，这已被并入PKCS#1中。<br>3)    PKCS#3：Diffie-Hellman密钥协议标准。PKCS#3描述了一种实现Diffie- Hellman密钥协议的方法。<br>4)    PKCS#4：最初是规定RSA密钥语法的，现已经被包含进PKCS#1中。<br>5)    PKCS#5：基于口令的加密标准。PKCS#5描述了使用由口令生成的密钥来加密8位位组串并产生一个加密的8位位组串的方法。PKCS#5可以用于加密私钥，以便于密钥的安全传输（这在PKCS#8中描述）。<br>6)    PKCS#6：扩展证书语法标准。PKCS#6定义了提供附加实体信息的X.509证书属性扩展的语法（当PKCS#6第一次发布时，X.509还不支持扩展。这些扩展因此被包括在X.509中）。<br>7)    PKCS#7：密码消息语法标准。PKCS#7为使用密码算法的数据规定了通用语法，比如数字签名和数字信封。PKCS#7提供了许多格式选项，包括未加密或签名的格式化消息、已封装（加密）消息、已签名消息和既经过签名又经过加密的消息。<br>8)    PKCS#8：私钥信息语法标准。PKCS#8定义了私钥信息语法和加密私钥语法，其中私钥加密使用了PKCS#5标准。<br>9)    PKCS#9：可选属性类型。PKCS#9定义了PKCS#6扩展证书、PKCS#7数字签名消息、PKCS#8私钥信息和PKCS#10证书签名请求中要用到的可选属性类型。已定义的证书属性包括E-mail地址、无格式姓名、内容类型、消息摘要、签名时间、签名副本（counter signature）、质询口令字和扩展证书属性。<br>10)    PKCS#10：证书请求语法标准。PKCS#10定义了证书请求的语法。证书请求包含了一个唯一识别名、公钥和可选的一组属性，它们一起被请求证书的实体签名（证书管理协议中的PKIX证书请求消息就是一个PKCS#10）。<br>11)    PKCS#11：密码令牌接口标准。PKCS#11或“Cryptoki”为拥有密码信息（如加密密钥和证书）和执行密码学函数的单用户设备定义了一个应用程序接口（API）。智能卡就是实现Cryptoki的典型设备。注意：Cryptoki定义了密码函数接口，但并未指明设备具体如何实现这些函数。而且Cryptoki只说明了密码接口，并未定义对设备来说可能有用的其他接口，如访问设备的文件系统接口。<br>12)    PKCS#12：个人信息交换语法标准。PKCS#12定义了个人身份信息（包括私钥、证书、各种秘密和扩展字段）的格式。PKCS#12有助于传输证书及对应的私钥，于是用户可以在不同设备间移动他们的个人身份信息。<br>13)    PDCS#13：椭圆曲线密码标准。PKCS#13标准当前正在完善之中。它包括椭圆曲线参数的生成和验证、密钥生成和验证、数字签名和公钥加密，还有密钥协定，以及参数、密钥和方案标识的ASN.1语法。<br>14)    PKCS#14：伪随机数产生标准。PKCS#14标准当前正在完善之中。为什么随机数生成也需要建立自己的标准呢？PKI中用到的许多基本的密码学函数，如密钥生成和Diffie-Hellman共享密钥协商，都需要使用随机数。然而，如果“随机数”不是随机的，而是取自一个可预测的取值集合，那么密码学函数就不再是绝对安全了，因为它的取值被限于一个缩小了的值域中。因此，安全伪随机数的生成对于PKI的安全极为关键。<br>15)    PKCS#15：密码令牌信息语法标准。PKCS#15通过定义令牌上存储的密码对象的通用格式来增进密码令牌的互操作性。在实现PKCS#15的设备上存储的数据对于使用该设备的所有应用程序来说都是一样的，尽管实际上在内部实现时可能所用的格式不同。PKCS#15的实现扮演了翻译家的角色，它在卡的内部格式与应用程序支持的数据格式间进行转换。</p>
<p>PKCS #1<br>RSA Cryptography Standard[1]<br>See RFC 3447. Defines the mathematical properties and format of RSA public and private keys (ASN.1-encoded in clear-text), and the basic algorithms and encoding/padding schemes for performing RSA encryption, decryption, and producing and verifying signatures.</p>
<p>PKCS #2    -    Withdrawn    No longer active as of 2010. Covered RSA encryption of message digests; subsequently merged into PKCS #1.</p>
<p>PKCS #3    1.4    Diffie–Hellman Key Agreement Standard[2]<br>A cryptographic protocol that allows two parties that have no prior knowledge of each other to jointly establish a shared secret key over an insecure communications channel.</p>
<p>PKCS #4    -    Withdrawn    No longer active as of 2010. Covered RSA key syntax; subsequently merged into PKCS #1.<br>PKCS #5    2.0    Password-based Encryption Standard[3]<br>See RFC 2898 and PBKDF2.</p>
<p>PKCS #6    1.5    Extended-Certificate Syntax Standard[4]<br>Defines extensions to the old v1 X.509 certificate specification. Obsoleted by v3 of the same.</p>
<p>PKCS #7    1.5    Cryptographic Message Syntax Standard[5]<br>See RFC 2315. Used to sign and/or encrypt messages under a PKI. Used also for certificate dissemination (for instance as a response to a PKCS #10 message). Formed the basis for S/MIME, which is as of 2010 based on RFC 5652, an updated Cryptographic Message Syntax Standard (CMS). Often used for single sign-on.</p>
<p>PKCS #8<br>1.2    Private-Key Information Syntax Standard[6]<br>See RFC 5958. Used to carry private certificate keypairs (encrypted or unencrypted).<br>PKCS #9    2.0    Selected Attribute Types[7]<br>See RFC 2985. Defines selected attribute types for use in PKCS #6 extended certificates, PKCS #7 digitally signed messages, PKCS #8 private-key information, and PKCS #10 certificate-signing requests.<br>PKCS #10    1.7    Certification Request Standard[8]<br>See RFC 2986. Format of messages sent to a certification authority to request certification of a public key. See certificate signing request.</p>
<p>PKCS #11<br>2.40    Cryptographic Token Interface[9]<br>Also known as “Cryptoki”. An API defining a generic interface to cryptographic tokens (see also hardware security module). Often used in single sign-on, public-key cryptography and disk encryption[10] systems. RSA Security has turned over further development of the PKCS #11 standard to the OASIS PKCS 11 Technical Committee.</p>
<p>PKCS #12<br>1.1    Personal Information Exchange Syntax Standard[11]<br>See RFC 7292. Defines a file format commonly used to store private keys with accompanying public key certificates, protected with a password-based symmetric key. PFX is a predecessor to PKCS #12.<br>This container format can contain multiple embedded objects, such as multiple certificates. Usually protected/encrypted with a password. Usable as a format for the Java key store and to establish client authentication certificates in Mozilla Firefox. Usable by Apache Tomcat.</p>
<p>PKCS #13    –    Elliptic Curve Cryptography Standard<br>(Apparently abandoned, only reference is a proposal from 1998.)[12]</p>
<p>PKCS #14    –    Pseudo-random Number Generation<br>(Apparently abandoned, no documents exist.)</p>
<p>PKCS #15    1.1    Cryptographic Token Information Format Standard[13]<br>Defines a standard allowing users of cryptographic tokens to identify themselves to applications, independent of the application’s Cryptoki implementation (PKCS #11) or other API. RSA has relinquished IC-card-related parts of this standard to ISO/IEC 7816-15.[14]</p>
<p>参考：<br><a href="https://apj.emc.com/emc-plus/rsa-labs/standards-initiatives/public-key-cryptography-standards.htm" target="_blank" rel="noopener">https://apj.emc.com/emc-plus/rsa-labs/standards-initiatives/public-key-cryptography-standards.htm</a><br><a href="https://en.wikipedia.org/wiki/PKCS" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/PKCS</a><br><a href="https://zh.wikipedia.org/wiki/%E5%85%AC%E9%92%A5%E5%AF%86%E7%A0%81%E5%AD%A6%E6%A0%87%E5%87%86" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E5%85%AC%E9%92%A5%E5%AF%86%E7%A0%81%E5%AD%A6%E6%A0%87%E5%87%86</a> </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/android_security_NetworkSecurityConfig_settings.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/android_security_NetworkSecurityConfig_settings.html" itemprop="url">NetworkSecurityConfig证书配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-11T00:00:00+00:00">
                2017-03-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/11Android-Security/" itemprop="url" rel="index">
                    <span itemprop="name">11Android_Security</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SecurityConfig证书配置 NetworkSecurityConfig</p>
<h2 id="SecurityConfig"><a href="#SecurityConfig" class="headerlink" title="SecurityConfig"></a>SecurityConfig</h2><p>此API是24版本的新特性，面向之前的版本并不适用，请适用自验证方式进行自定义验证</p>
<h2 id="添加application安全配置文件"><a href="#添加application安全配置文件" class="headerlink" title="添加application安全配置文件"></a>添加application安全配置文件</h2><pre><code>&lt;application android:networkSecurityConfig=&quot;@xml/network_security_config&quot; /&gt;
</code></pre><h2 id="配置network-security-config-xml"><a href="#配置network-security-config-xml" class="headerlink" title="配置network_security_config.xml"></a>配置network_security_config.xml</h2><pre><code>标签和继承关系
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;network-security-config&gt;</span><br><span class="line">  &lt;base-config   /&gt;      &lt;!--0 或 1 个--&gt;</span><br><span class="line">  &lt;domain-config&gt;     &lt;!--任意数量--&gt;</span><br><span class="line">		&lt;domain /&gt;      &lt;!--1 个或多个 --&gt;</span><br><span class="line">  &lt;trust-anchors  /&gt;    &lt;!--0 或 1 个--&gt;</span><br><span class="line">  &lt;pin-set /&gt;   &lt;!--0 或 1 个--&gt;</span><br><span class="line">  &lt;domain-config /&gt;   &lt;!--任意数量的已嵌套--&gt;</span><br><span class="line">  &lt;/domain-config&gt;    </span><br><span class="line">  &lt;debug-overrides /&gt;    &lt;!--0 或 1 个 --&gt;</span><br><span class="line">&lt;/network-security-config&gt;</span><br></pre></td></tr></table></figure>
<h2 id="匹配策略及标签解析"><a href="#匹配策略及标签解析" class="headerlink" title="匹配策略及标签解析"></a>匹配策略及标签解析</h2><p>先进行域名匹配，匹配到domain-config(domain-config必须包含至少一个domain标签)，则执行相关的trust-anchors和pin-set策略(覆盖上层策略)，如果没有找到trust-anchors等策略就向上一级找，找到终止，使用找到的trust-anchors策略。 查找策略，内部的domain-config   =&gt;  domain-config =&gt; base-config =&gt; platform默认方式   (target sdk &gt; 23 system;  23 or lower: system or user).<br>如果域名没有匹配到domain-config那么使用上一级策略。</p>
<p><domain-config><br>是按照 domain 元素的定义连接到特定目的地的配置。 仅对domain元素匹配到的域名生效。如果目的地不在 domain-config 涵盖范围内的所有连接所使用的默认配置。<br>如果未在特定条目中设置值，将使用通用条目中的值。例如，未在 domain-config 中设置的值将从父级 domain-config（如果已嵌套）或者 base-config（如果未嵌套）中获取。未在 base-config 中设置的值将使用平台默认值。如果找到执行相关trust-anchors和pin-set策略。</domain-config></p>
<p>includeSubdomains<br><figure class="highlight plain"><figcaption><span>includeSubdomains</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如果为 &quot;true&quot;，此域规则将与域及所有子域（包括子域的子域）匹配。否则，该规则仅适用于精确匹配项。</span><br><span class="line"></span><br><span class="line">expiration=&quot;2018-01-01&quot;</span><br><span class="line">```&lt;pin-set expiration=&quot;2018-01-01&quot;&gt;</span><br></pre></td></tr></table></figure></p>
<p>设置pin策略失效时间，失效后将不再进行该pin策略的检查。<br>这有助于防止尚未更新的应用出现连接性问题。不过，设置固定的到期时间可能会绕过证书固定。<br>设置的日期一定要保证这个时间之前证书CA和公钥不会发生变化，如果发生变化那么将认证失败。<br>假如设置的日期早于CA有效期，那么这个日期之后pin策略将失效。</p>
<p>digest=”SHA-256”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;pin digest=&quot;SHA-256&quot;&gt;7HIpactkIAq2Y49orFOOQKurWxmmSFZhBCoQYcRhJ3Y=&lt;/pin&gt;</span><br></pre></td></tr></table></figure></p>
<p>PEM Base64编码，使用如下命令获取Base64加密的Sha256的公钥，可以用server本身证书或中间CA或根CA，一个验证通过即可<br>openssl x509 -in GeoTrust_G3.cer -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64</p>
<p>overridePins=[“true” | “false”]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;certificates src=[&quot;system&quot; | &quot;user&quot; | &quot;raw resource&quot;]    overridePins=[&quot;true&quot; | &quot;false&quot;] /&gt;</span><br></pre></td></tr></table></figure></p>
<p>针对certificates标签生效，指定此来源的 CA 是否绕过证书固定。如果为 “true”，则不对此来源的 CA 签署的证书链执行证书固定。这对于调试 CA 或测试对应用的安全流量进行中间人攻击 (MiTM) 非常有用。<br>默认值为 “false”，除非在 debug-overrides 元素中另外指定（在这种情况下，默认值为 “true”）</p>
<p>cleartextTrafficPermitted=”false”<br><figure class="highlight plain"><figcaption><span>cleartextTrafficPermitted</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例如，应用可能需要确保与 secure.example.com 的所有连接始终通过 HTTPS 完成，以防止来自恶意网络的敏感流量。</span><br><span class="line">res/xml/network_security_config.xml：</span><br></pre></td></tr></table></figure></p>
<p>&lt;?xml version=”1.0” encoding=”utf-8”?&gt;</p>
<p><network-security-config><br>    <domain-config cleartexttrafficpermitted="false"><br>        <domain includesubdomains="true">secure.example.com</domain><br>    </domain-config><br></network-security-config><br><code>`</code><br>更多请参考Google专业测试用例，详细可参考如下APK：<br>frameworks/base/tests/ NetworkSecurityConfigTest测试APK</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/android_app_tech_summup.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/android_app_tech_summup.html" itemprop="url">深度理解Android技术总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-03T00:00:00+00:00">
                2017-03-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/10Android-App/" itemprop="url" rel="index">
                    <span itemprop="name">10Android_App</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>#深度理解Android技术总结</p>
<p>##Android基础</p>
<p>###开发文档<br><a href="https://developer.android.com/guide/index.html?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/guide/index.html?hl=zh-cn</a> </p>
<p>###阿里巴巴Android开发规范<br><a href="https://github.com/Blankj/AndroidStandardDevelop" target="_blank" rel="noopener">https://github.com/Blankj/AndroidStandardDevelop</a></p>
<p>###框架层知识点<br>分层架构 MVC MVVM MVP<br><a href="https://developer.android.com/topic/libraries/architecture/guide.html" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/architecture/guide.html</a><br><a href="https://github.com/googlesamples/android-architecture" target="_blank" rel="noopener">https://github.com/googlesamples/android-architecture</a><br><a href="https://github.com/googlesamples/android-architecture-components" target="_blank" rel="noopener">https://github.com/googlesamples/android-architecture-components</a><br>组件化 模块化 容器化 Atlas small<br><a href="https://yq.aliyun.com/articles/7239" target="_blank" rel="noopener">https://yq.aliyun.com/articles/7239</a><br>依赖注入 Dagger2<br><a href="https://toutiao.io/posts/5a3fp5/preview" target="_blank" rel="noopener">https://toutiao.io/posts/5a3fp5/preview</a><br>AOP面向切面编程 Aspectj<br><a href="http://blog.csdn.net/xwh_1230/article/details/78213160" target="_blank" rel="noopener">http://blog.csdn.net/xwh_1230/article/details/78213160</a><br><a href="http://blog.csdn.net/xwh_1230/article/details/78225258" target="_blank" rel="noopener">http://blog.csdn.net/xwh_1230/article/details/78225258</a><br>事件驱动 EventBus otto EventPoster<br><a href="http://blog.csdn.net/android2me/article/details/66973037" target="_blank" rel="noopener">http://blog.csdn.net/android2me/article/details/66973037</a><br>RxJava数据异步<br><a href="http://blog.csdn.net/caihongdao123/article/details/51897793" target="_blank" rel="noopener">http://blog.csdn.net/caihongdao123/article/details/51897793</a><br><a href="https://www.jianshu.com/p/5e93c9101dc5" target="_blank" rel="noopener">https://www.jianshu.com/p/5e93c9101dc5</a><br>Http Restful请求框架Retrofit<br><a href="https://segmentfault.com/a/1190000005638577" target="_blank" rel="noopener">https://segmentfault.com/a/1190000005638577</a><br>框架列表<br><a href="https://www.ctolib.com/cheatsheets-Android-ch.html" target="_blank" rel="noopener">https://www.ctolib.com/cheatsheets-Android-ch.html</a><br>常用的Util<br><a href="https://github.com/Blankj/AndroidUtilCode/blob/master/utilcode/README-CN.md" target="_blank" rel="noopener">https://github.com/Blankj/AndroidUtilCode/blob/master/utilcode/README-CN.md</a><br>Android开源项目源码解析<br><a href="https://github.com/android-cn/android-open-project-analysis" target="_blank" rel="noopener">https://github.com/android-cn/android-open-project-analysis</a></p>
<h2 id="Android中间件"><a href="#Android中间件" class="headerlink" title="Android中间件"></a>Android中间件</h2><p>###插件化<br><a href="http://blog.csdn.net/ganyao939543405/article/details/76146760" target="_blank" rel="noopener">http://blog.csdn.net/ganyao939543405/article/details/76146760</a></p>
<p>###热修复<br><a href="https://github.com/Tencent/tinker/wiki" target="_blank" rel="noopener">https://github.com/Tencent/tinker/wiki</a></p>
<p>###Hook框架<br><a href="http://www.snowdream.tech/2016/09/02/android-install-xposed-framework/" target="_blank" rel="noopener">http://www.snowdream.tech/2016/09/02/android-install-xposed-framework/</a><br><a href="https://jaq.alibaba.com/community/art/show?articleid=809" target="_blank" rel="noopener">https://jaq.alibaba.com/community/art/show?articleid=809</a></p>
<p>##VirtualXposed 和epic<br><a href="https://github.com/android-hacker/VirtualXposed" target="_blank" rel="noopener">https://github.com/android-hacker/VirtualXposed</a><br><a href="https://github.com/tiann/epic" target="_blank" rel="noopener">https://github.com/tiann/epic</a><br><a href="http://weishu.me/2017/12/02/non-root-xposed/" target="_blank" rel="noopener">http://weishu.me/2017/12/02/non-root-xposed/</a></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/posts/android_app_tech_summup.html#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/android_security_certificate_apps.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/android_security_certificate_apps.html" itemprop="url">Android证书应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-25T00:00:00+00:00">
                2017-02-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/11Android-Security/" itemprop="url" rel="index">
                    <span itemprop="name">11Android_Security</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android Settings中主要有凭据存储管理、VPN和WIFI应用等应用到证书的知识。</p>
<h2 id="凭据存储-系统TAB-用户TAB-和用户凭据区别"><a href="#凭据存储-系统TAB-用户TAB-和用户凭据区别" class="headerlink" title="凭据存储(系统TAB/用户TAB)和用户凭据区别"></a>凭据存储(系统TAB/用户TAB)和用户凭据区别</h2><p>Setting中的显示</p>
<ol>
<li>受信任凭据-系统TAB<br>显示/system/etc/security/cacerts/ 下的根Root证书文件，system分区只读，不可更改</li>
<li><p>受信任凭据-用户TAB<br>显示TrustCertificateStore默认路径的CA证书文件，默认路径本来是/data/misc/keychain/cacerts-added，在ActivityThread.main起来的时候改为用户相关/data/misc/user/0/<br>// Make sure TrustedCertificateStore looks in the right place for CA certificates<br>final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());<br>TrustedCertificateStore.setDefaultUserDirectory(configDir);</p>
</li>
<li><p>用户凭据<br>显示/data/misc/keystore/user_0/下，1000开头的所有证书文件。<br>包含有用户导入的X509和PKCS格式<br>包含有用户导入的X509证书，作为系统证书的补充<br>KeyChain API，使得用户可以安全导入自己的证书，包含两种格式X.509(PEM or ASN.1 DER encoded)/PKCS#12，安装过程提示Wlan或VPN/APP两个选项，如下：<br>1)如果选择WLAN，那么只有Wifi可用此证书，且不会在用户凭据和受信任的凭据里边显示。<br>2)如果选择VPN/APP，那么第三方应用均可请求使用该证书，且会根据证书类型，选择安全的具体位置，比如CER/DER这种格式会在用户凭据和受信任凭据同时添加显示，PKCS12只会用户凭据里显示。第三方应用可以调用KeyChain接口获取PrivateKey进行签名等操作，还可以使用证书/PublicKey进行加密等操作，但第一次调用接口使用证书需要弹窗验证权限，具体使用依据程序需要，可以用于HTTPS/Email等客户端验证<br>查看/data/misc/keystore/user_0目录文件如下：<br>1000_CACERT_123<br>1000_CACERT_12306<br>1000_USRPKEY_My+PKey+PChain<br>1010_CACERT_12306<br>1010_USRCERT_xxx_WPA_EAPIEEE8021X_TLS_NULL<br>1010_USRPKEY_xxx_WPA_EAPIEEE8021X_TLS_NULL<br>1010_USRPKEY_My+PKey+PChain<br>此目录均为android.security.Keystore接口导入，可加密可不加密存储。<br>文件可分为三类：<br>1000  对system可见，上层可以通过KeyChain接口请求用户授权访问<br>1010  对wifi可见, 其他不可见<br>other_uid 只对本身应用可见，system等不可见<br>其中主要又可分为CACERT、USRPKEY、USRCERT这三种类别。</p>
</li>
</ol>
<h2 id="VPN应用"><a href="#VPN应用" class="headerlink" title="VPN应用"></a>VPN应用</h2><h3 id="VPN的关键技术参数"><a href="#VPN的关键技术参数" class="headerlink" title="VPN的关键技术参数"></a>VPN的关键技术参数</h3><p>VPN产品的关键技术参数包括：支持那些标准（PPTP，L2TP，IPsec，MSLP，SOCK5），支持那些加密算法；最大加密强度是多少；是否支持公钥体系PKI），及IKE密钥管理等。</p>
<h3 id="VPN分类"><a href="#VPN分类" class="headerlink" title="VPN分类"></a>VPN分类</h3><p>IPSEC/Xauth<br>Background    PPTP 是一个基于 PPP 的很基本的协议。PPTP 是微软 Windows 平台第一个支持的 VPN 协议。PPTP 标准并没有实际描述加密和授权特性，并且依赖于 PPP 协议的隧道来实现安全功能。    L2TP 是一个在 IETF RFC 3193 中被正式标准化的高级协议。推荐在需要安全加密的地方用来替代 PPTP。        OpenVPN 是一个高级的开源 VPN 解决方案，由 “OpenVPN technologies” 支持，并且已经成为开源网络领域里的事实标准。OpenVPN 使用成熟的 SSL/TLS 加密协议。<br>Data Encryption    PPP 负载是使用微软点对点协议（Microsoft’s Point-to-Point Encryption protocol，MPPE）加密。MPPE 实现了 RSA RC4 加密算法，并使用最长 128 位密钥。    L2TP 负载使用标准的 IPSec 协议加密。在 RFC 4835 中指定了使用 3DES 或 AES 加密算法作为保密方式。        OpenVPN 使用 OpenSSL 库来提供加密。OpenSSL 支持好几种不同的加密算法，如：3DES，AES，RC5 等。<br>Setup / Configuration    Windows 所有版本和大多数其他操作系统包括移动平台都内建了对 PPTP 的支持。PPTP 只需要一个用户名和密码，以及一个服务器地址，所以安装和配置相当简单。    从 2000/XP 起的所有 Windows 平台和 Mac OS X 10.3+ 都内建了 L2TP/IPSec 的支持。大多数现代的移动平台比如 iPhone 和 Android 也有内建的客户端。        OpenVPN 不包含在任何操作系统中，需要安装客户端软件，但安装也是相当简单，基本上 5 分钟可以完成。<br>Speed    由于使用 128 位密钥，加密开销相比 OpenVPN 使用 256位密钥要小，所以速度感觉稍快一点，但这个差异微不足道。    L2TP/IPSec 将数据封装两次，所以相比其他竞争者效率稍低，速度也慢一些。        当使用默认的 UDP 模式，OpenVPN 的表现是最佳的。<br>Ports    PPTP 使用 TCP 1723 端口和 GRE（协议 47）。通过限制 GRE 协议，PPTP 可以轻易地被封锁。    L2TP/IPSec 使用 UDP 500 端口用来初始化密钥交换，使用协议 50 用来传输 IPSec 加密的数据（ ESP ），使用 UDP 1701 端口用来初始化 L2TP 的配置，还使用 UDP 4500 端口来穿过 NAT。L2TP/IPSec 相比 OpenVPN 容易封锁，因为它依赖于固定的协议和端口。        OpenVPN 可以很容易的配置为使用任何端口运行，也可以使用 UDP 或 TCP 协议。为了顺利穿越限制性的防火墙，可以将 OpenVPN 配置成使用 TCP 443 端口，因为这样就无法和标准的 HTTPS 无法区分，从而极难被封锁。<br>Stability / Compatibility    PPTP 不如 OpenVPN 可靠，也不能像 OpenVPN 那样在不稳定网络中快速恢复。另外还有部分同 GRE 协议和一些路由器的兼容性问题。    L2TP/IPSec 比 OpenVPN 更复杂，为了使在 NAT 路由器下的设备可靠地使用，配置可以会更加困难。但是，只要服务器和客户端都支持 NAT 穿越，那么就没什么问题了。        无论是无线网络、蜂窝网络，还是丢包和拥塞经常发生的不可靠网络，OpenVPN 都非常稳定、快速。对于那些相当不可以的连接，OpenVPN 有一个 TCP 模式可以使用，但是要牺牲一点速度，因为将 TCP 封装在 TCP 时效率不高。<br>Security weaknesses    微软实现的 PPTP 有一个严重的安全问题（serious security vulnerabilities）。对于词典攻击来说 MSCHAP-v2 是很脆弱的，并且 RC4 算法也会遭到“位翻转攻击（ bit-flipping attack ）”。如果保密是重要的，微软也强烈建议升级到 IPSec。    IPSec 没有明显的漏洞，当和安全加密算法如 AES 一起使用时，被认为是很安全的。        OpenVPN 也没有明显漏洞，当和安全加密算法如 AES 一起使用时，也被认为是相当安全的。<br>Client compatibility    •    Windows<br>•    Mac OS X<br>•    Linux<br>•    Apple iOS<br>•    Android<br>•    DD-WRT    Windows<br>Android    •        •    Windows<br>•    Mac OS X<br>•    Linux<br>Conclusion    由于主要的安全漏洞，除了兼容性以外没有好的理由选择使用 PPTP。如果你的设备既不支持 L2TP/IPSec 又不支持 OpenVPN，那么 PPTP 是一个合理的选择。如果关心快速安装和简易配置，那么 L2TP/IPSec 值得考虑。    L2TP/IPSec 是优秀的，但相比 OpenVPN 的高效和杰出的稳定性要落后一点。如果你使用运行 iOS 或 Android 的移动设备，那么这就是最佳的选择，因为 OpenVPN 目前还不支持这些平台。另外，如果需要快速安装，L2TP/IPSec 也是一个较佳的选择。        对于所有的 Windows, Mac OS X 以及 Linux 桌面用户来说，OpenVPN 是最好的选择。OpenVPN 速度快，并且安全可信。但劣势是缺乏对移动设备的支持，另外还需要安装第三方客户端。</p>
<p>参考资料：<br><a href="https://liweitianux.wordpress.com/2011/04/30/pptp-l2tp-openvpn/" target="_blank" rel="noopener">https://liweitianux.wordpress.com/2011/04/30/pptp-l2tp-openvpn/</a><br><a href="http://www.cnblogs.com/haitao-fan/archive/2012/05/30/2526142.html" target="_blank" rel="noopener">http://www.cnblogs.com/haitao-fan/archive/2012/05/30/2526142.html</a><br><a href="https://linux.cn/article-3407-1.html" target="_blank" rel="noopener">https://linux.cn/article-3407-1.html</a> </p>
<h3 id="主要概述"><a href="#主要概述" class="headerlink" title="主要概述"></a>主要概述</h3><p><strong>PPTP</strong><br>(Point-to-Point Tunneling Protocol (PPTP))<br>PPTP使用传输控制协议（TCP）创建控制通道来发送控制命令，以及利用通用路由封装（GRE）通道来封装点对点协议（PPP）数据包以发送数据<br>微软点对点协议（PPP）协议堆栈中，提供了各种标准的身份验证与加密机制来支持PPTP.<br>可以搭配PAP、CHAP、MS-CHAP v1/v2或EAP-TLS来进行身份验证。也可以搭配微软点对点加密（MPPE）或IPSec的加密机制来提高安全性</p>
<p><strong>L2TP(Layer Two Tunneling Protocol)</strong><br>IPSec PSK、IPSec RSA<br>整个L2TP数据包，包括有效附载（payload）及标头（header），皆是用用户数据报协议（UDP）来发送。<br>L2TP本身并不提供加密和认证，但常用IPsec来确保L2TP的安全及完整性，两种协议的组合一般被称为L2TP/IPsec<br>PPTP和 L2TP都是OSI第二层的VPN，也是较早期的VPN协议，在IPsec出现前是最主要的VPN类型，今天使用仍然相当广泛，典型地是使用两台托管的Windows 2000服务器作为VPN网关。前者是微软在1996年制定，后者则由CISCO汇同微软在PPTP和L2F的基础上制定。第二层协议对ＰＰＰ协议本身并没有做任何修改，只是将用户的 PPP帧基于GRE封装成IP报文。<br>PPTP和L2TF均具有简单易行的优点，但是它们的可扩展性都不好。更重要的是，它们都没有提供内在的安全机制，它们不能支持企业和企业的外部客户以及供应商之间会话的保密性需求，因此它们不支持用来连接企业内部网和企业的外部客户及供应商的企业外部网Extranet的概念。Extranet需要对隧道进行加密并需要相应的密钥管理机制。PPTP和L2TP限制同时最多只能连接255个用户。端点用户需要在连接前手工建立加密信道。认证和加密受到限制，没有强加密和认证支持。安全程度差，是PPTP/L2TF简易型VPN最大的弱点。<br>PPTP和L2TP最适合用于客户端远程访问虚拟专用网，作为安全要求高的企业信息，使用PPTP/L2TP与明文传送的差别不大。PPTP/L2TP不适合于向Ipv6的转移。</p>
<p><strong>IPSEC</strong><br>Xauth PSK、Xauth RSA、Hybrid RSA<br>IPsec协议工作在OSI模型的第三层，使其在单独使用时适于保护基于TCP或UDP的协议（如安全套接子层（SSL）就不能保护UDP层的通信流）。这就意味着，与传输层或更高层的协议相比，IPsec协议必须处理可靠性和分片的问题，这同时也增加了它的复杂性和处理开销。相对而言，SSL/TLS依靠更高层的TCP（OSI的第四层）来管理可靠性和分片。<br>IPSec是IETF(Internet Engineer Task Force)完善的安全标准，它把几种安全技术结合在一起形成一个较为完整的体系，通过对数据加密、认证、完整性检查来保证数据传输的可靠性、私有性和保密性。IPSec由IP认证头AH(Authentication Header)、IP安全载荷封载ESP(Encapsulated Security Payload)和密钥管理协议组成。是目前支持最广泛的VPN协议。<br>IPSec协议是一个范围广泛、开放的虚拟专用网安全协议。IPSec适应向IP v6迁移，它提供所有在网络层上的数据保护，提供透明的安全通信。IPSec用密码技术从三个方面来保证数据的安全。即：<br>认证：用于对主机和端点进行身份鉴别。<br>完整性检查：用于保证数据在通过网络传输时没有被修改。<br>加密：加密IP地址和数据以保证私有性。<br>IPsec是完全意义上的VPN，能直接与PKI、CA设备密切协同完成认证功能。IPSec的缺占是需要固定范围的IP地址，因此在动态分配IP地址时不太适合于IPSec。（图腾VPN是目前不多的部分支持动态IP的VPN网关技术）；除了TCP/IP协议外，IPSec不支持其他协议。除了包过滤之外，它没有指定其他访问控制方法。另外，微软在windows中没有集成对IPSec的支持，因此，windows客户端需要专门的软件或硬件的支持。<br>IPSec最适合可信的网关到网关之间的虚拟专用网，即企业广域网(Extranet)的构建。<br>SSTP<br>SSL/TLS</p>
<p><strong>VPN配置文件</strong><br>由系统创建并由KeyStore进行加密存储，如下：<br>配置文件解密后<br> 包含：名称/Type/IP/用户名/密码////用户证书/CA证书/ 等内容<br>Type: 1 = L2TP/IPSEC<br>Type: 0= PPTP<br>Type: 4= IPSec Xauth</p>
<p><strong>证书使用：</strong><br>At runtime, the framework retrieves the client certifcate (w in<br>Listing 9-8) and the CA certifcate (u in Listing 9-8) from the system keystore and passes them to racoon via the control socket.<br>运行时，framework按照配置文件将证书从系统keystore中抽取出来，通过socket传递给racoon守护进程。</p>
<p>The private key blob is never directly passed to the racoon daemon, only its alias (vpnclient). 私钥文件不传递给racoon，而是用到的时候直接由keystore进行加解密操作，从而保证私钥安全性。</p>
<p>PPTP和L2TP守护进程：<br>PPTP和L2TP隧道实现，包含PPP守护进程mtpd、和PPPoPNS和PPPoLAC内核驱动。<br>IPSec实现，包含内置IPSec内核支持和racoon IKE守护进程。<br>Init.rc中可以看到两个守护进程的声明：</p>
<p>系统设置启动VPN后，通过套接字发送控制命令，IP地址网络掩码等，两个守护进程负责根据参数创建隧道，完成接口配置，写入并处理/data/misc/vpn/state文件，调用系统ConnectivityService配置路由服务器等，然后发送给netd(root权限运行)，开始修改内核包过滤和路由表。</p>
<p><strong>VPN对Android SDK开放的API</strong><br>VPNService和VPNService.Builder<br>这种方法最好的实现是OpenVPN的实现，参考OpenVPN</p>
<p>参考：<br><a href="https://developer.android.com/reference/android/net/VpnService.html" target="_blank" rel="noopener">https://developer.android.com/reference/android/net/VpnService.html</a><br><a href="https://developer.android.com/reference/android/net/VpnService.Builder.html" target="_blank" rel="noopener">https://developer.android.com/reference/android/net/VpnService.Builder.html</a> </p>
<h2 id="WLan应用"><a href="#WLan应用" class="headerlink" title="WLan应用"></a>WLan应用</h2><h3 id="WiFi分类"><a href="#WiFi分类" class="headerlink" title="WiFi分类"></a>WiFi分类</h3><p>WiFi无线电分类：<br>Wi-Fi可分为五代。[6]由于ISM频段中的2.4GHz频段被广泛使用，例如微波炉、蓝牙，它们会干扰WiFi，令速度减慢，5GHz干扰则较小。双频路由器可同时使用2.4GHz和5GHz，设备则只能使用某一个频段。<br>第一代802.11，1997年制定，只使用2.4GHz，最快2Mbit/s<br>第二代802.11b，1999年制定，只使用2.4GHz，最快11Mbit/s，正逐渐淘汰<br>第三代802.11g/a，2007收录，分别使用2.4GHz和5GHz，最快54Mbit/s<br>            802.11i，安全和鉴权（Authentication）方面的补充。<br>第四代802.11n，2008以后，可使用2.4GHz或5GHz，20和40MHz信道宽度下最快72和150Mbit/s<br>第五代802.11ac，2011年后，只使用5GHz</p>
<h3 id="Wifi认证分类："><a href="#Wifi认证分类：" class="headerlink" title="Wifi认证分类："></a>Wifi认证分类：</h3><p>WEP    口令即可<br>WPA/WPA2   PSK    口令即可<br>802.1 EAP    PEAP<br>TLS<br>TTLS<br>PWD<br>SIM<br>AKA    PEAP认证，通过SSL连接，只认证服务端<br>TLS双向认证，需要签发X.509客户端证书私钥，可以撤销禁止网络访问<br>TTLS不需要认证客户端<br>PWD预共享秘钥<br>WAPI PSK    口令即可<br>WAPI CERT    AS证书/用户证书    </p>
<p>其中WiFi Protected Access (WPA) 和 WiFi Protected Access II(WPA) 是主流协议，均支持PSK预共享密钥模式，也成为Personal个人模式。<br>PSK模式缺点：需要预共享口令，用户增加无法扩展，需要撤销某设备的访问，必须要修改共享的口令凭据，还要同步修改其他设备的配置，不能区分用户和设备，难以计费和进行灵活的访问控制。</p>
<p>WPA和WPA2进行扩展EAP(Extensible Authentication Protocol)，如图其中一种需要证书认证的方式：</p>
<p>Supplicant:　无线设备手机等<br>Authenticator: 网络的网关，AP无线接入点。负责验证客户端身份<br>Authentication：Radius服务器，验证客户端凭据并根据预先预置的访问策略决定是否授予访问权限 </p>
<p>EAP是一种支持不同认证类型的认证框架。再认证开始之前，客户端和认证服务器需要协商一种同时支持的认证协议 TLS/TTLS/PWD等</p>
<h3 id="WIFI框架"><a href="#WIFI框架" class="headerlink" title="WIFI框架"></a>WIFI框架</h3><p>内核层：WLAN适配内核驱动模块 ko<br>原声守护进程：wpa_supplicant,1010 与WPA认证器进行密钥协商，并且控制与WIFI驱动关联<br>硬件抽象层HAL：libhardware_legacy原声库，通过套接字发送命令给wpa_supplicant<br>系统服务：WifiService和公开接口WifiManager (WifiStateMachine)<br>系统UI:系统设置进行控制、SystemUI连接状态栏<br>WiFi上层接口配置：<a href="http://www.cnblogs.com/wotakuc/archive/2013/03/22/2975886.html" target="_blank" rel="noopener">http://www.cnblogs.com/wotakuc/archive/2013/03/22/2975886.html</a></p>
<h3 id="WiFI配置文件"><a href="#WiFI配置文件" class="headerlink" title="WiFI配置文件"></a>WiFI配置文件</h3><p>/data/misc/wifi/wpa_supplicant.conf<br>0660 文件所有者system 文件组wifi<br>只有系统应用和wifi守护进程可以对文件进行读取和修改，第三方不可以读取和修改。</p>
<p>包含<br>SSID标识<br>Key_mgmt网络认证协议<br>Psk 预共享密钥</p>
<p>另外有<br>Identity身份<br>Passwork密码<br>ca_cert证书，守护进程调用IKeyStoreService原生服务远程接口，根据URI获取证书<br>Phase2阶段二认证协议</p>
<p>另外还有<br>Client_cert 用户证书<br>Engine_id 引擎ID<br>Keyid 用户密钥ID Alias别名</p>
<p>配置文件中所有需要预共享口令密码的都是以明文进行存储，但用户私钥用keystore进行存储于硬件或软实现加密存储。</p>
<p>其中证书文件从Settings里边导入，如果选择Wifi形式导入，那么密钥所有者就是wifi用户1010，而且只有以wifi用户运行的系统组件，才可以访问到该密钥。 </p>
<p>参考资料：<br><a href="https://zh.wikipedia.org/wiki/IEEE_802.11" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/IEEE_802.11</a><br><a href="http://www.howtogeek.com/167783/htg-explains-the-difference-between-wep-wpa-and-wpa2-wireless-encryption-and-why-it-matters/" target="_blank" rel="noopener">http://www.howtogeek.com/167783/htg-explains-the-difference-between-wep-wpa-and-wpa2-wireless-encryption-and-why-it-matters/</a><br><a href="http://m.8p8p.net/ztnews/03xrzw212ooxtwpzuz1x2z1x.html" target="_blank" rel="noopener">http://m.8p8p.net/ztnews/03xrzw212ooxtwpzuz1x2z1x.html</a><br><a href="http://bbs.ruijie.com.cn/thread-2559-1-1.html" target="_blank" rel="noopener">http://bbs.ruijie.com.cn/thread-2559-1-1.html</a> </p>
<h2 id="设备管理DPM-Android-for-work"><a href="#设备管理DPM-Android-for-work" class="headerlink" title="设备管理DPM (Android for work)"></a>设备管理DPM (Android for work)</h2><p>设备管理跟证书相关的接口<br>Public interface for managing policies enforced on a device. Most clients of this class must be registered with the system as a device administrator. Additionally, a device administrator may be registered as either a profile or device owner. A given method is accessible to all device administrators unless the documentation for that method specifies that it is restricted to either device or profile owners. Any application calling an api may only pass as an argument a device administrator component it owns. Otherwise, a SecurityException will be thrown.</p>
<p><strong>installCaCert</strong><br>boolean installCaCert (ComponentName admin,<br>                byte[] certBuffer)<br> Installs the given certificate as a user CA. 可以使用system|signature签名级别的android.permission.MANGE_CA_CETIFICATES权限来安装证书，安装后位于/data/misc/user/0/cacerts-added<br>SecurityException<br>if admin is not null and not a device or profile owner.</p>
<p><strong>installKeyPair</strong><br>boolean installKeyPair (ComponentName admin,<br>                PrivateKey privKey,<br>                Certificate[] certs,<br>                String alias,<br>                boolean requestAccess) </p>
<p>Called by a device or profile owner, or delegated certificate installer, to install a certificate chain and corresponding private key for the leaf certificate. All apps within the profile will be able to access the certificate chain and use the private key, given direct user approval.<br>The caller of this API may grant itself access to the certificate and private key immediately, without user approval. It is a best practice not to request this unless strictly necessary since it opens up additional security vulnerabilities.<br>SecurityException<br>if admin is not null and not a device or profile owner.</p>
<p>参考资料：<br><a href="https://developer.android.com/reference/android/app/admin/DevicePolicyManager.html" target="_blank" rel="noopener">https://developer.android.com/reference/android/app/admin/DevicePolicyManager.html</a><br><a href="https://developer.android.com/guide/topics/admin/device-admin.html" target="_blank" rel="noopener">https://developer.android.com/guide/topics/admin/device-admin.html</a><br><a href="https://developer.android.com/reference/android/app/admin/DeviceAdminReceiver.html" target="_blank" rel="noopener">https://developer.android.com/reference/android/app/admin/DeviceAdminReceiver.html</a><br><a href="https://www.ncsc.gov.uk/guidance/android-end-user-device-security" target="_blank" rel="noopener">https://www.ncsc.gov.uk/guidance/android-end-user-device-security</a> </p>
<h2 id="证书存储-KeyStore-Keymaster"><a href="#证书存储-KeyStore-Keymaster" class="headerlink" title="证书存储 KeyStore/Keymaster"></a>证书存储 KeyStore/Keymaster</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/jvm_art_jvm_class_load.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/jvm_art_jvm_class_load.html" itemprop="url">JVM类加载</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-15T00:00:00+00:00">
                2017-01-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/03JVM-ART/" itemprop="url" rel="index">
                    <span itemprop="name">03JVM&ART</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="JVM类结构类加载类执行"><a href="#JVM类结构类加载类执行" class="headerlink" title="JVM类结构类加载类执行"></a>JVM类结构类加载类执行</h2><p><img src="https://upload-images.jianshu.io/upload_images/11010834-69c39eb46c77c1ad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br><img src="https://upload-images.jianshu.io/upload_images/11010834-29050b0ee7c4fa2a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="类加载的五个过程：加载、验证、准备、解析、初始化。"><a href="#类加载的五个过程：加载、验证、准备、解析、初始化。" class="headerlink" title="类加载的五个过程：加载、验证、准备、解析、初始化。"></a>类加载的五个过程：加载、验证、准备、解析、初始化。</h3><ul>
<li>加载: 根据全限定名来获取定义类的二进制字节流,然后将该字节流所代表的静态结构转化为方法区的运行时数据结构,最后在生成一个代表该类的Class对象,作为方法区这些数据的访问入口.</li>
<li>验证:主要时为了确保class文件的字节流中包含的信息符合当前虚拟机的要求,并且不会危害虚拟机自身的安全.包含四个阶段的验证过程:</li>
<li>文件格式验证:保证输入的字节流能够正确地解析并存储在方法区之内,格式上符合描述一个java类型信息的要求</li>
<li>元数据验证:字节码语义信息的验证,以保证描述的信息符合java语言规范.验证点有:这个类是否有父类等.</li>
<li>字节码验证:主要是进行数据流和控制流分析,保证被校验类的方法在运行时不会做出危害虚拟机安全的行为.</li>
<li><p>符号引用验证:对符号引用转化为直接引用过程的验证.</p>
</li>
<li><p>准备:为类变量分配内存并设置变量的初始值,这些内存在方法区进行分配.</p>
</li>
<li>解析:将虚拟机常量池中的符号引用转化为直接引用的过程.解析主要是针对类或接口、字段、类方法、类接口方法四类.</li>
<li>初始化:执行静态变量的赋值操作以及静态代码块,完成初识化.初始化过程保证了父类中定义的初始化优先于子类的初始化.但接口不需要执行父类的初始化.</li>
</ul>
<h3 id="JVM类加载时机"><a href="#JVM类加载时机" class="headerlink" title="JVM类加载时机"></a>JVM类加载时机</h3><ul>
<li>何时开始类的初始化<br>什么情况下需要开始类加载过程的第一个阶段:”加载”。虚拟机规范中并没强行约束，这点可以交给虚拟机的的具体实现自由把握，但是对于初始化阶段虚拟机规范是严格规定了如下几种情况，如果类未初始化会对类进行初始化。</li>
</ul>
<ol>
<li>创建类的实例</li>
<li>访问类的静态变量(除常量【被final修辞的静态变量】原因:常量一种特殊的变量，因为编译器把他们当作值(value)而不是域(field)来对待。如果你的代码中用到了常变量(constant variable)，编译器并不会生成字节码来从对象中载入域的值，而是直接把这个值插入到字节码中。这是一种很有用的优化，但是如果你需要改变final域的值那么每一块用到那个域的代码都需要重新编译。</li>
<li>访问类的静态方法</li>
<li>反射如(Class.forName(“my.xyz.Test”))</li>
<li>当初始化一个类时，发现其父类还未初始化，则先出发父类的初始化</li>
<li>虚拟机启动时，定义了main()方法的那个类先初始化<br>以上情况称为称对一个类进行“主动引用”，除此种情况之外，均<strong>有且仅有这几种情况</strong>不会触发类的初始化，称为“被动引用”<br>接口的加载过程与类的加载过程稍有不同。接口中不能使用static{}块。当一个接口在初始化时，并不要求其父接口全部都完成了初始化，只有真正在使用到父接口时（例如引用接口中定义的常量）才会初始化。</li>
</ol>
<ul>
<li>被动引用例子</li>
</ul>
<ol>
<li>子类调用父类的静态变量，子类不会被初始化。只有父类被初始化。。对于静态字段，只有直接定义这个字段的类才会被初始化.</li>
<li>通过数组定义来引用类，不会触发类的初始化<br>SubClass[] sca = new SubClass[10];// 被动引用2</li>
<li>访问类的常量，不会初始化类</li>
</ol>
<p>具体可参考 <a href="https://www.cnblogs.com/javaee6/p/3714716.html" target="_blank" rel="noopener">https://www.cnblogs.com/javaee6/p/3714716.html</a></p>
<h3 id="JVM-加载-class-文件的原理机制"><a href="#JVM-加载-class-文件的原理机制" class="headerlink" title="JVM 加载 class 文件的原理机制"></a>JVM 加载 class 文件的原理机制</h3><p>JVM 中类的装载是由类加载器（ClassLoader） 和它的子类来实现的，Java 中的类加载器是一个重要的 Java 运行时系统组件，它负责在运行时查找和装入类文件中的类。<br>由于 Java 的跨平台性，经过编译的 Java 源程序并不是一个可执行程序，而是一个或多个类文件。当 Java 程序需要使用某个类时，JVM 会确保这个类已经被加载、连接(验证、准备和解析)和初始化。类的加载是指把类的 .class 文件中的数据读入到内存中，通常是创建一个字节数组读入 .class 文件，然后产生与所加载类对应的 Class 对象。加载完成后，Class 对象还不完整，所以此时的类还不可用。当类被加载后就进入连接阶段，这一阶段包括验证、准备(为静态变量分配内存并设置默认的初始值)和解析(将符号引用替换为直接引用)三个步骤。最后 JVM 对类进行初始化，包括：</p>
<ol start="3">
<li>如果类存在直接的父类并且这个类还没有被初始化，那么就先初始化父类；</li>
<li>如果类中存在初始化语句，就依次执行这些初始化语句。<br>类的加载是由类加载器完成的，类加载器包括：启动类加载器（BootStrap）、扩展加载器（Extension）、应用程序加载器（Application）和用户自定义类加载器（java.lang.ClassLoader的子类）。从JDK 1.2开始，类加载过程采取了父亲委托机制(PDM)。PDM 更好的保证了 Java 平台的安全性，在该机制中，JVM 自带的 Bootstrap 是根加载器，其他的加载器都有且仅有一个父类加载器。类的加载首先请求父类加载器加载，父类加载器无能为力时才由其子类加载器自行加载。JVM 不会向 Java 程序提供对 Bootstrap 的引用。下面是关于几个类加载器的说明：</li>
</ol>
<ul>
<li>Bootstrap：启动类加载器，一般用本地代码实现，负责加载JVM基础核心类库。加载存放在&lt;JAVA_HOME&gt;/lib目录中的类库（如rt.jar）；</li>
<li>Extension ClassLoader：扩展加载器， 负责加载&lt;JAVA_HOME&gt;/lib/ext目录中的 ，或被java.ext.dirs 系统属性所指定的目录中加载类库，它的父加载器是 Bootstrap；</li>
<li>Application ClassLoader：应用程序加载器，其父类是Extension。它是应用最广泛的类加载器。它从环境变量 classpath 或者系统属性 java.class.path 所指定的目录中记载类，是用户自定义加载器的默认父加载器。</li>
</ul>
<p>缺点:</p>
<ul>
<li>双亲委派模型很好地解决了各个类加载器的基础类统一问题(越基础的类由越上层的加载器进行加载)，基础类之所以被称为“基础”，是因为它们总是作为被调用代码调用的API。但是，如果基础类又要调用用户的代码时，双亲委派模型无法满足要求。 因为Bootstrap加载器无法找到永不代码类。</li>
</ul>
<p>为了解决这个困境，Java设计团队只好引入了一个不太优雅的设计：线程上下文件类加载器(Thread Context ClassLoader)。这个类加载器可以通过java.lang.Thread类的setContextClassLoader()方法进行设置，如果创建线程时还未设置，它将会从父线程中继承一个；如果在应用程序的全局范围内都没有设置过，那么这个类加载器默认就是应用程序类加载器。了有线程上下文类加载器，JNDI服务使用这个线程上下文类加载器去加载所需要的SPI代码，也就是父类加载器请求子类加载器去完成类加载动作，这种行为实际上就是打通了双亲委派模型的层次结构来逆向使用类加载器，已经违背了双亲委派模型，但这也是无可奈何的事情。Java中所有涉及SPI的加载动作基本上都采用这种方式，例如JNDI,JDBC,JCE,JAXB和JBI等。 Dubbo的SPI也是采用这种机制实现。</p>
<h3 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h3><p>除了顶层的启动类加载器外,其余的类加载器都应当有自己的父类加载器.顺序依次是:</p>
<ul>
<li>Bootstrap ClassLoader: 启动类加载器,加载java_home/lib中的类</li>
<li>Extension ClassLoader: 扩展类加载器,加载java_home/lib/ext目录下的类库</li>
<li>Application ClassLoader: 应用程序类加载器,加载用户类路径上指定类库.</li>
</ul>
<p>双亲委派模型的工作原理是:如果一个类加载器受到了类加载请求,它首先不会自己去尝试加载这个类,而把这个请求委派给父类加载器去完成,每一层次的类加载器都是如此,因此所有的加载请求最终都应该传送到顶层的启动类加载器中,只有当父类加载器反馈自己无法完成加载请求时,加载器才尝试自己加载.这种方式保证了Oject类(JDK 核心类)在各个加载器加载环境中都是同一个类.</p>
<h3 id="分派：静态分派与动态分派。"><a href="#分派：静态分派与动态分派。" class="headerlink" title="分派：静态分派与动态分派。"></a>分派：静态分派与动态分派。</h3><p>多态性特征的一些最基本的体现. 静态类型是编译期可知的,动态类型是在运行时可知.Human h =new Man(); Human是静态类型,Man时动态类型.</p>
<p>所有依赖于<strong>静态类型定位方法执行版本的分派动作称作静态分派,最典型的应用是方法重载.静态分派发生在编译阶段</strong>。</p>
<p>动态分派是<strong>根据动态类型来确定执行的版本,所以只有到运行时才能确定具体的执行方法版本</strong>.典型的代表时重写.其过程如下:</p>
<ol>
<li>首先找到操作数栈栈顶的第一个元素所执向对象的实际类型,记做C.</li>
<li>如果在类型C中找到和常量中的描述符和简单名称都相符的方法,则进行范围权限校验.如果通过则返回该方法的直接引用,否则抛出IllegalAccessError异常.</li>
<li>否则按照继承关系从下往上一次对C的各个父类进行第2步的搜索和验证过程.</li>
<li>如果始终没有找到就抛出AbstractMethodError异常. 方法的接受者和方法的参数统称方法宗量,根据分配基于多少中宗量可以分为单分派和多分派.java是静态多分派,动态分派属于单分派.</li>
</ol>
<p>动态分派的实现: 动态分派时非常频繁的动作,而且动态分派的方法版本选择过程需要运行时在类的方法元数据中搜索合适的目标方法,因此出于性能的考虑,在方法区中建立一个虚方法表,用来保存各个方法的实际入口地址.如果某个方法的子类中没有被重写,那么子类的虚方法表里面的地址入口和父类相同方法的地址入口是一致的.都是指向父类的实现入口,如果子类中重写了这个方法,子类方法表中的地址将会被替换为指向子类实现版本的入口地址.虚方法表在类加载的连接阶段进行初始化.</p>
<h3 id="Student-s-new-Student-在内存中做了那些事情"><a href="#Student-s-new-Student-在内存中做了那些事情" class="headerlink" title="Student s= new Student(),在内存中做了那些事情"></a>Student s= new Student(),在内存中做了那些事情</h3><ol start="7">
<li>加载Student.class 文件进内存</li>
<li>在栈内存为s开辟空间</li>
<li>在堆内存为Student对象开辟空间</li>
<li>学生对象的成员变量进行显示初始化</li>
<li>通过构造方法对学生对象变量赋值</li>
<li>学生对象初始完毕，把对象地址赋值给s变量</li>
</ol>
<p>相关资料： <a href="http://blog.csdn.net/wisgood/article/details/16818243" target="_blank" rel="noopener">http://blog.csdn.net/wisgood/article/details/16818243</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/jvm_art_jvm_deep_learn.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/jvm_art_jvm_deep_learn.html" itemprop="url">JVM深入理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-06T00:00:00+00:00">
                2017-01-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/03JVM-ART/" itemprop="url" rel="index">
                    <span itemprop="name">03JVM&ART</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Java虚拟机概览<br><a href="https://www.cnblogs.com/2014asm/p/7999049.html" target="_blank" rel="noopener">https://www.cnblogs.com/2014asm/p/7999049.html</a></p>
<h2 id="内存分布概要"><a href="#内存分布概要" class="headerlink" title="内存分布概要"></a>内存分布概要</h2><p><img src="https://upload-images.jianshu.io/upload_images/11010834-b029a0c862019b02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h2 id="垃圾回收概要"><a href="#垃圾回收概要" class="headerlink" title="垃圾回收概要"></a>垃圾回收概要</h2><p><img src="https://upload-images.jianshu.io/upload_images/11010834-8b13a027fac13d84.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br><img src="https://upload-images.jianshu.io/upload_images/11010834-259b2042b7752763.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h2 id="JVM类字节码结构"><a href="#JVM类字节码结构" class="headerlink" title="JVM类字节码结构"></a>JVM类字节码结构</h2><p><img src="https://upload-images.jianshu.io/upload_images/11010834-69c39eb46c77c1ad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h2 id="类加载机制"><a href="#类加载机制" class="headerlink" title="类加载机制"></a>类加载机制</h2><p><img src="https://upload-images.jianshu.io/upload_images/11010834-29050b0ee7c4fa2a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h2 id="类执行引擎"><a href="#类执行引擎" class="headerlink" title="类执行引擎"></a>类执行引擎</h2><ul>
<li>多态<br>从虚拟机角度看Java多态-&gt;（重写override）的实现原理<br><a href="https://www.cnblogs.com/2014asm/p/8633660.html" target="_blank" rel="noopener">https://www.cnblogs.com/2014asm/p/8633660.html</a></li>
<li>动态委派和静态委派</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/android_review_taskAffinity_lauchMode_intentflag.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/android_review_taskAffinity_lauchMode_intentflag.html" itemprop="url">Android查缺补漏-taskAffinity/lauchMode/Intent Flag/task record</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-22T00:00:00+00:00">
                2016-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/21Android-review/" itemprop="url" rel="index">
                    <span itemprop="name">21Android_review</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="taskAffinity、launchmode、Intent-FLAG-ACTIVITY-XXX-有关的堆栈和back键返回等"><a href="#taskAffinity、launchmode、Intent-FLAG-ACTIVITY-XXX-有关的堆栈和back键返回等" class="headerlink" title="taskAffinity、launchmode、Intent.FLAG_ACTIVITY_XXX 有关的堆栈和back键返回等"></a>taskAffinity、launchmode、Intent.FLAG_ACTIVITY_XXX 有关的堆栈和back键返回等</h2><p><a href="http://www.voidcn.com/blog/fengniuma/article/p-3214732.html" target="_blank" rel="noopener">http://www.voidcn.com/blog/fengniuma/article/p-3214732.html</a><br><a href="https://blog.piasy.com/2017/01/16/Android-Basics-Task-and-LaunchMode" target="_blank" rel="noopener">https://blog.piasy.com/2017/01/16/Android-Basics-Task-and-LaunchMode</a><br><a href="http://blog.csdn.net/scnuxisan225/article/details/44930321" target="_blank" rel="noopener">http://blog.csdn.net/scnuxisan225/article/details/44930321</a><br><a href="http://blog.csdn.net/tuhuolong/article/details/8844936" target="_blank" rel="noopener">http://blog.csdn.net/tuhuolong/article/details/8844936</a></p>
<p><strong>taskAffinity解释：</strong><br>taskAffinity 标示以该Activity为root的所在task的名字。属性值推荐用.开头。<br>可以通过<application>给所有activity设置taskAffinity。</application></p>
<p><application taskaffinity=".newtask"><br>   <activity ***=""><br>    ***<br></activity></application><br>也可以单独设置activity 的taskAffinity</p>
<p><activity taskaffinity=".newtask"><br>如果<application>或<acitivity>都没有设置taskAffinity，则系统默认赋值为应用程序包名。也就是说taskAffinity要么是自己定义的值，要么去应用程序包名。<br>值得注意的是，如果launcher activity使用默认taskAffinity，通过launcher activity启动的一个activity B，【B配置了taskAffinity属性，并且没有设置启动新的task, 那么其实B的taskAffinity就失效了】，因为task的名字是由root activity的taskAffinity决定的。<br>taskAffinity结合singleTask和SingleIntance和FLAG_ACTIVITY_NEW_TASK 一起使用会产生效果，单独的task只存在一个activity，该task上的activity清除等。</acitivity></application></activity></p>
<p><strong>Launchmode</strong><br>Standard  singleTop  singleTask singleInstance主要有这几种模式。<br>其中standard模式比较简单，直接在当前栈启动一个新的activity，而不管之前是否存在相同activity实例。<br>其中singleTop模式也比较简单，直接在当前栈查找是否存在该activity实例，如果存在直接调用onNewIntent方法，如果不存在那么直接创建改Activity。 不关注TaskAffinity。<br>其中singleTask模式较为麻烦，先寻找名字为taskAffnity指定的task，如果该task存在这个activity，那么清楚之上的所有activity，然后调用OnNewIntent方法。如果不存在该task，那么创建task，创建activity。<br>其中singleIntance模式，要求Activity实例独占task，所以先寻找是否存在该Activity，存在那么直接调用onNewIntent，如果不存在，那么创建该task和activity。 如果从该activity调用其他Activity那么会切换到其他task栈上，因为该activity独占task。<br>Intent.FLAG_ACTIVITY_XXX<br>FLAG_ACTIVITY_NEW_TASK 配合FLAG_ACTIVITY_CLEAR_TOP的时候，才会和“singleTask”行为一致–在已经存在目标activity的情况下，清除上层全部Activity.<br>FLAG_ACTIVITY_SINGLE_TOP  = singleTop<br>FLAG_ACTIVITY_CLEAR_TOP + FLAG_ACTIVITY_NEW_TASK = singleTask</p>
<h2 id="ActivityRecord、TaskRecord、ActivityStack之间的关系"><a href="#ActivityRecord、TaskRecord、ActivityStack之间的关系" class="headerlink" title="ActivityRecord、TaskRecord、ActivityStack之间的关系"></a>ActivityRecord、TaskRecord、ActivityStack之间的关系</h2><p>ActivityStackSupervisor.mActivityDisplays-&gt; ActivityDisplay.mStacks -&gt; ActivityStack.mTaskHistory -&gt; TaskRecord.mActivities -&gt; ActivityRecord<br>简单来说就是一下类的关系图，ActivityStackSupervisor与ActivityDisplay都是系统唯一，ActivityDisplay负责管理很多ActivityStack，ActivityDisplay主要有Home Stack和App Stack这两个栈；一个ActivityStack负责管理很多TaskRecord，一个TaskRecord又包含很多ActivityRecord。一个activityRecord包含<br>ProcessRecord app //跑在哪个进程  TaskRecord task //跑在哪个task ActivityInfo info // Activity信息 int mActivityType //Activity类型  ActivityState state //Activity状态  ApplicationInfo appInfo //跑在哪个app<br><a href="http://gityuan.com/2017/06/11/activity_record/" target="_blank" rel="noopener">http://gityuan.com/2017/06/11/activity_record/</a><br><a href="http://blog.csdn.net/itachi85/article/details/77542286" target="_blank" rel="noopener">http://blog.csdn.net/itachi85/article/details/77542286</a><br><a href="http://blog.csdn.net/kebelzc24/article/details/53747506" target="_blank" rel="noopener">http://blog.csdn.net/kebelzc24/article/details/53747506</a><br><a href="http://duanqz.github.io/2016-02-01-Activity-Maintenance#activitystack" target="_blank" rel="noopener">http://duanqz.github.io/2016-02-01-Activity-Maintenance#activitystack</a></p>
<h2 id="Intent-filter-action-category-Data-scheme匹配规则"><a href="#Intent-filter-action-category-Data-scheme匹配规则" class="headerlink" title="Intent-filter action category Data scheme匹配规则"></a>Intent-filter action category Data scheme匹配规则</h2><p><a href="http://blog.csdn.net/iispring/article/details/48481793" target="_blank" rel="noopener">http://blog.csdn.net/iispring/article/details/48481793</a></p>
<h2 id="intent匹配"><a href="#intent匹配" class="headerlink" title="intent匹配"></a>intent匹配</h2><p><a href="https://developer.android.com/guide/components/intents-filters.html?hl=zh-cn#Resolution" target="_blank" rel="noopener">https://developer.android.com/guide/components/intents-filters.html?hl=zh-cn#Resolution</a></p>
<h2 id="PendingIntent"><a href="#PendingIntent" class="headerlink" title="PendingIntent"></a>PendingIntent</h2><p>如果Intent对象的Action是相同的，Data也是相同的，Categories也是相同的，Components也是相同的，Flags也是相同的），并且之前获取的PendingIntent对象还有效的话，那么该进程获取到的PendingItent对象将获得同一个对象的引用，可以通过cancel()方法来从系统中移除它。<br>PendingIntent对象由系统持有，因此不能通过设置不同的Extra来生成不同的PendingIntent对象，系统只通过刚才在上面提到的几个要素来判断PendingIntent对象是否是相同的。<br>PendingIntent有以下flag：<br>FLAG_CANCEL_CURRENT:如果当前系统中已经存在一个相同的PendingIntent对象，那么就将先将已有的PendingIntent取消，然后重新生成一个PendingIntent对象。<br>FLAG_NO_CREATE:如果当前系统中不存在相同的PendingIntent对象，系统将不会创建该PendingIntent对象而是直接返回null。<br>FLAG_ONE_SHOT:该PendingIntent只作用一次。<br>FLAG_UPDATE_CURRENT:如果系统中已存在该PendingIntent对象，那么系统将保留该PendingIntent对象，但是会使用新的Intent来更新之前PendingIntent中的Intent对象数据，例如更新Intent中的Extras。<br>创建PendingIntent方式：<br>PendingIntent.getActivity (context, requestCode, broadIntent, flags)<br>PendingIntent.getBroadcast(context,requestCode, broadIntent, flags)<br>PendingIntent.getService (context, requestCode, broadIntent, flags)<br>API文档里虽然未使用requestCode参数，但实际上是通过该参数来区别不同的Intent的<br><a href="http://blog.csdn.net/yangwen123/article/details/8019739" target="_blank" rel="noopener">http://blog.csdn.net/yangwen123/article/details/8019739</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/jvm_art_java_gc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/jvm_art_java_gc.html" itemprop="url">JVM垃圾回收</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-17T00:00:00+00:00">
                2016-12-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/03JVM-ART/" itemprop="url" rel="index">
                    <span itemprop="name">03JVM&ART</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="GC的收集方法的原理与特点，分别用在什么地方，如果让你优化收集方法，有什么思路？"><a href="#GC的收集方法的原理与特点，分别用在什么地方，如果让你优化收集方法，有什么思路？" class="headerlink" title="GC的收集方法的原理与特点，分别用在什么地方，如果让你优化收集方法，有什么思路？"></a>GC的收集方法的原理与特点，分别用在什么地方，如果让你优化收集方法，有什么思路？</h3><ul>
<li>标记清理：首先标记所有需要回收的对象，在标记完成后统一回收掉所有被标记的对象，它的标记的对象。缺点是效率低，且存在内存碎片。主要用于老生代垃圾回收。</li>
<li>标记整理：首先标记所有需要回收的对象，在标记完成后让所有存活的对象都向一端移动，然后直接清理掉端边界意外的内存。用于老年代。</li>
<li>复制算法：将内存按容量划分为大小相等的一块，每次只用其中一块。当内存用完了，将还存活的对象复制到另一块内存，然后把已使用过的内存空间一次清理掉。实现简单，高效。一般用于新生代。一般是将内存分为一块较大的Eden空间和两块较小的Survivor空间。HotSpot虚拟机默认比例是8:1,。每次使用Eden和一块Survivor，当回收时将这两块内存中还存活的对象复制到Survivor然后清理掉刚才Eden和Survivor的空间。如果复制过程内存不够使用则向老年代分配担保。</li>
<li>分代收集算法：根据对象的生存周期将内存划分为新生代和老年代，根据年代的特点采用最适当的收集算法。</li>
</ul>
<h3 id="GC收集器有哪些？CMS收集器与G1收集器的特点。"><a href="#GC收集器有哪些？CMS收集器与G1收集器的特点。" class="headerlink" title="GC收集器有哪些？CMS收集器与G1收集器的特点。"></a>GC收集器有哪些？CMS收集器与G1收集器的特点。</h3><ul>
<li>Serial: 单线程收集器，只会使用一个CPU或一条收集器线程去完成，垃圾回收工作，更重要的是在进行垃圾回收时，必须暂停其他所有的工作线程。（Stop the world）。简单高效，用于新生代。</li>
<li>ParNew: 是Serial收集器的多线程版本，垃圾回收时采用多线程方式进行回收。默认情况下使用的线程数是cpu数量。除了serial收集器，目前只有它能和CMS收集器配合工作。是server模式下首选的新生代收集器。</li>
<li>Parallel Scavenge: 使用复制算法收集器，也是一个并行的多线程收集器。Parallel Scavenge收集器与其他收集器关注点不同，其它收集器主要关注缩短垃圾回收时用户线程的停顿时间。而它关心吞吐量，即运行用户代码时间/(运行用户代码时间 + 垃圾收集时间)。停顿时间越短越适合需要与用户交互的程序，高吞吐量则可以最高效率的利用CPU时间。</li>
<li>Serial Old: 老年代，单线程收集器，使用标记整理算法。主要有两个用途，一是和Parallel Scavenge 收集器配合使用，二是作为CMS的后备方案在并发收集器发生Concurrent Mode Failure时候使用。</li>
<li>Parallel Old:并行的老年代版本收集器，使用标记整理算法。主要与Parallel Scavenge配合使用。</li>
<li>CMS：是以获得最短回收停顿时间为目标的收集器，使用标记清除算法。整个过程包括4个：</li>
</ul>
<ol>
<li>初始标记: 标记Gc ROOTS能直接关联到的对象</li>
<li>并发标记：进行Roots Traceing的过程</li>
<li>重新标记：修正并发标记期间因用户继续工作导致标记产生变动</li>
<li>并发清除：并发清除数据。 初始标记和重新标记需要stop the world. 并发标记和并发清除过程用户线程和收集器线程可以并行执行。</li>
</ol>
<ul>
<li>G1(Garbage First): 基于标记-整理算法的收集器,不会产生空间碎片.它可以精确控制停顿,能够让使用者明确指定一个长度为M毫秒的时间片段内,消耗集上的时间不超过N秒.是不牺牲吞吐量的前提下完成低停顿的.G1将整个java堆(新生和老生)划分为大小相同的区,并跟踪这些区上发生的变化.在后台维护一个优先列表,每次根据允许的收集时间优先回收垃圾最多的区域.</li>
</ul>
<p>现在公司中很多都采用了G1 垃圾回收期，建议大家多深入了解下G1，更多参考: <a href="https://github.com/zhengjianglong915/note-of-interview/blob/master/java/G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8.md" target="_blank" rel="noopener">G1垃圾回收器</a></p>
<h3 id="GC的两种判定方法：引用计数与根搜索算法"><a href="#GC的两种判定方法：引用计数与根搜索算法" class="headerlink" title="GC的两种判定方法：引用计数与根搜索算法"></a>GC的两种判定方法：引用计数与根搜索算法</h3><ul>
<li>引用计数： 给对象添加一个引用计数器，每当有一个地方引用该对象时，计数器值加1，当引用失效时，计数器值减1,。任何时候计数器都为0的对象就是不可能再被使用的。它很难解决对象之间相互循环引用问题。</li>
<li>根搜索算法（GC Roots Traceing）: 通过一系列名为“GC Roots”的对象作为起点，从这些节点开始向下搜索，搜索走过的路径成为引用链，当一个对象到GC Roots没有任何引用链相连时，则证明此对象不可用。</li>
</ul>
<h3 id="GC-Roots对象一般是："><a href="#GC-Roots对象一般是：" class="headerlink" title="GC Roots对象一般是："></a>GC Roots对象一般是：</h3><p>虚拟机栈中的引用对象，方法区中类静态属性引用的对象，方法区常量引用的对象等。</p>
<h2 id="Java中的四种引用"><a href="#Java中的四种引用" class="headerlink" title="Java中的四种引用"></a>Java中的四种引用</h2><p>Java中提供这四种引用类型主要有两个目的：第一是可以让程序员通过代码的方式决定某些对象的生命周期；第二是有利于JVM进行垃圾回收。</p>
<ul>
<li>强引用：程序代码中的普通引用。如Object obj = new Object(),只要强引用存在，垃圾回收器就不会回收。在不使用对象时应及时将引用设置为null，便于垃圾回收。</li>
<li>软引用：描述一些有用但并非必须的对象。对于软引用关联的对象在系统将要发生内存溢出异常之前，将会把这些对象列进回收范围之中进行第二次回收。SoftRefence</li>
<li>弱引用：描述非必须对象，比软引用弱一些。被弱引用关联的对象只能生存到下一次垃圾收集发生之前。无论当前内存是否足够，都会回收掉只被弱引用关联的对象。WeakRefence</li>
<li>虚引用：最弱的引用，不管是否有虚引用存在，完全不会对对象生存时间构成影响，也无法通过虚引用来取得一个对象实例。唯一目的是希望能够在这个对象被垃圾回收器之前收到系统通知。PhantomReference</li>
</ul>
<p>相关参考：<a href="https://www.cnblogs.com/dolphin0520/p/3784171.html" target="_blank" rel="noopener">Java 如何有效地避免OOM：善于利用软引用和弱引用</a></p>
<h3 id="OOM你遇到过哪些情况"><a href="#OOM你遇到过哪些情况" class="headerlink" title="OOM你遇到过哪些情况"></a>OOM你遇到过哪些情况</h3><ul>
<li>java.lang.OutOfMemoryError: Java heap space ——&gt;java堆内存溢出，此种情况最常见，一般由于内存泄露或者堆的大小设置不当引起。</li>
<li>java.lang.OutOfMemoryError: PermGen space ——&gt;java永久代溢出，即方法区溢出了，一般出现于大量Class或者jsp页面，或者采用cglib等反射机制的情况，因为上述情况会产生大量的Class信息存储于方法区。</li>
<li>java.lang.StackOverflowError ——&gt; 不会抛OOM error，但也是比较常见的Java内存溢出。JAVA虚拟机栈溢出，一般是由于程序中存在死循环或者深度递归调用造成的，栈大小设置太小也会出现此种溢出。可以通过虚拟机参数<strong>-Xss</strong>来设置栈的大小。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fitzlee.github.io/posts/jvm_art_java_memory.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fitz.Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fitz.Lee">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/jvm_art_java_memory.html" itemprop="url">JVM内存布局</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-01T00:00:00+00:00">
                2016-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/03JVM-ART/" itemprop="url" rel="index">
                    <span itemprop="name">03JVM&ART</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="JVM虚拟机内存结构，以及它们的作用"><a href="#JVM虚拟机内存结构，以及它们的作用" class="headerlink" title="JVM虚拟机内存结构，以及它们的作用"></a>JVM虚拟机内存结构，以及它们的作用</h2><p>线程私有：栈区，本地方法栈，pc指针<br>线程共有：方法区，堆区</p>
<h2 id="JVM内存"><a href="#JVM内存" class="headerlink" title="JVM内存"></a>JVM内存</h2><p>内存分布大纲<br><img src="https://upload-images.jianshu.io/upload_images/11010834-b029a0c862019b02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>垃圾回收大纲<br><img src="https://upload-images.jianshu.io/upload_images/11010834-8b13a027fac13d84.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br><img src="https://upload-images.jianshu.io/upload_images/11010834-259b2042b7752763.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="介绍JVM中7个区域，然后把每个区域可能造成内存的溢出的情况说明"><a href="#介绍JVM中7个区域，然后把每个区域可能造成内存的溢出的情况说明" class="headerlink" title="介绍JVM中7个区域，然后把每个区域可能造成内存的溢出的情况说明"></a>介绍JVM中7个区域，然后把每个区域可能造成内存的溢出的情况说明</h3><ul>
<li>程序计数器：看做当前线程所执行的字节码行号指示器。是线程私有的内存，且唯一一块不报OutOfMemoryError异常的内存区域。</li>
<li>Java虚拟机栈：用于描述java方法的内存模型：每个方法被执行时都会同时创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法被调用直至执行完成的过程就对应着一个栈帧在虚拟机中从入栈到出栈的过程。如果线程请求的栈深度大于虚拟机所允许的深度就报StackOverflowError, 如果虚拟 机栈可以动态扩展，当拓展时无法申请到足够的内存会抛出OutOfMemoryError. 是线程私有的。</li>
<li>本地方法栈：与虚拟机栈相似，不同的在于它是为虚拟机使用到Native方法服务的。会抛出StackOverflowError和OutOfMemoryError。是线程私有的。</li>
<li>Java堆: 是所有线程共享的一块内存，在虚拟机启动时创建。此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配内存。如果堆上没有内存完成实例的分配就会报OutOfMemoryError.</li>
<li>方法区（永久代）：用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。当方法区无法满足内存分配需求时，会抛出OutOfMemoryError。是共享内存。</li>
<li>运行时常量池：用于存放编译器生成的各种字面量和符号引用，是方法区的一部分。无法申请内存时抛出OutOfMemoryError。</li>
<li>直接内存：不是虚拟机运行时数据的一部分，也不是java虚拟机规范中定义的区域，是计算机直接的内存空间。这部分也被频繁使用，如JAVA NIO的引入基于通道和缓存区的I/O使用native函数直接分配堆外内存。如果内存不足会报OutOfMemoryError。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Fitz.Lee" />
          <p class="site-author-name" itemprop="name">Fitz.Lee</p>
           
              <p class="site-description motion-element" itemprop="description">Security & Android & Java</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">91</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">144</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/fitzlee" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:fitz.lee@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.jianshu.com/u/c7757daadf27" target="_blank" title="JianShu">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                    
                      JianShu
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.anquanke.com/" title="Anquanke" target="_blank">Anquanke</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.gityuan.com/" title="Gityuan" target="_blank">Gityuan</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fitz.Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
